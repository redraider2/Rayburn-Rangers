-- =========================
-- Rayburn Ranger (SQLite)
-- =========================

PRAGMA foreign_keys = ON;

-- 1) Videos (YouTube or local uploads)
CREATE TABLE IF NOT EXISTS videos (
  id TEXT PRIMARY KEY,                 -- e.g. YouTube videoId OR local UUID
  source TEXT NOT NULL,                -- "youtube" | "local"
  url TEXT,                            -- YouTube URL or local file reference
  title TEXT,
  channel TEXT,
  published_at TEXT,                   -- ISO string
  created_at TEXT NOT NULL             -- ISO string (when we stored it)
);

CREATE INDEX IF NOT EXISTS idx_videos_source ON videos(source);
CREATE INDEX IF NOT EXISTS idx_videos_published_at ON videos(published_at);

-- 2) Ramps / Access points (from ArcGIS FeatureServer)
CREATE TABLE IF NOT EXISTS ramps (
  id TEXT PRIMARY KEY,                 -- stable id (OBJECTID as text is fine)
  name TEXT NOT NULL,
  type TEXT,
  lat REAL NOT NULL,
  lng REAL NOT NULL,
  raw_json TEXT,                       -- store full properties JSON as text
  created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_ramps_lat_lng ON ramps(lat, lng);
CREATE INDEX IF NOT EXISTS idx_ramps_name ON ramps(name);

-- 3) Link a video to a ramp (manual MVP, can add auto later)
CREATE TABLE IF NOT EXISTS video_ramp_links (
  id TEXT PRIMARY KEY,                 -- UUID
  video_id TEXT NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  ramp_id TEXT NOT NULL REFERENCES ramps(id) ON DELETE CASCADE,
  confidence INTEGER NOT NULL DEFAULT 75,  -- 0-100
  note TEXT,
  created_at TEXT NOT NULL,

  UNIQUE(video_id, ramp_id)            -- prevent duplicates
);

CREATE INDEX IF NOT EXISTS idx_links_video_id ON video_ramp_links(video_id);
CREATE INDEX IF NOT EXISTS idx_links_ramp_id ON video_ramp_links(ramp_id);

-- 4) Transcription runs (weekly Whisper jobs)
CREATE TABLE IF NOT EXISTS transcription_runs (
  id TEXT PRIMARY KEY,                 -- UUID
  engine TEXT NOT NULL,                -- "whisper" | "openai-whisper" etc.
  model TEXT,                          -- "base" | "small" etc
  started_at TEXT NOT NULL,
  finished_at TEXT,
  status TEXT NOT NULL,                -- "ok" | "error"
  error TEXT
);

CREATE INDEX IF NOT EXISTS idx_runs_started_at ON transcription_runs(started_at);

-- 5) Transcripts per video
CREATE TABLE IF NOT EXISTS transcripts (
  id TEXT PRIMARY KEY,                 -- UUID
  video_id TEXT NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  run_id TEXT REFERENCES transcription_runs(id) ON DELETE SET NULL,
  language TEXT,                       -- "en"
  text TEXT NOT NULL,                  -- full transcript (optional; can be big)
  created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_transcripts_video_id ON transcripts(video_id);

-- 6) Bait dictionary (optional but helpful; you can seed this)
CREATE TABLE IF NOT EXISTS bait_dictionary (
  id TEXT PRIMARY KEY,                 -- slug e.g. "texas-rig"
  label TEXT NOT NULL,                 -- "Texas Rig"
  category TEXT,                       -- "rig" | "soft-plastic" | "jig" ...
  aliases_json TEXT                    -- JSON array of alias strings
);

CREATE INDEX IF NOT EXISTS idx_bait_category ON bait_dictionary(category);

-- 7) Bait hits (the money table)
CREATE TABLE IF NOT EXISTS bait_hits (
  id TEXT PRIMARY KEY,                 -- UUID
  video_id TEXT NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  ramp_id TEXT REFERENCES ramps(id) ON DELETE SET NULL,   -- can be NULL until linked
  bait_id TEXT,                        -- references bait_dictionary.id if known
  bait_text TEXT NOT NULL,             -- what was matched ("texas rig", etc.)
  count INTEGER NOT NULL DEFAULT 1,

  -- Optional evidence to show the user
  evidence_json TEXT,                  -- JSON: timestamps, snippet, segments

  -- Meta
  confidence REAL,                     -- 0.0 - 1.0 from matcher
  extracted_from TEXT NOT NULL,        -- "captions" | "whisper"
  extracted_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_bait_hits_video_id ON bait_hits(video_id);
CREATE INDEX IF NOT EXISTS idx_bait_hits_ramp_id ON bait_hits(ramp_id);
CREATE INDEX IF NOT EXISTS idx_bait_hits_bait_text ON bait_hits(bait_text);
